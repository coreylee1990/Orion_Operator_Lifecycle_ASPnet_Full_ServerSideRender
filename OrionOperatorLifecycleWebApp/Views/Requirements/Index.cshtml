@await Html.PartialAsync("_CertDuplicateModal")
@await Html.PartialAsync("_StatusDeleteWarningModal")
@{
    ViewData["Title"] = "Requirements Editor";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="/css/requirements-editor.css" rel="stylesheet">

<div class="container" style="display: flex; flex-direction: row;">
        <div class="vertical-panel" style="width: 360px; min-width: 300px; max-width: 420px; background: linear-gradient(135deg, #232b3b 0%, #1e293b 100%); border-radius: 18px; margin: 30px 20px 30px 30px; padding: 28px 18px; display: flex; flex-direction: column; gap: 28px; height: fit-content; box-shadow: 0 8px 32px rgba(0,0,0,0.25);">
            <h2 id="divisionTitle" style="margin-bottom: 0; color: #60a5fa; font-weight: bold; font-size: 1.35rem; text-align: center; letter-spacing: 0.5px;">All Divisions</h2>
                        <!-- Add Status to Division Accordion (moved and restyled) -->
                        <div class="accordion" id="addStatusAccordion" style="background: #232b3b; border-radius: 12px; box-shadow: 0 2px 8px rgba(60,60,80,0.10); margin-bottom: 10px;">
                            <div class="accordion-item border-primary" style="background: #232b3b; border-radius: 12px;">
                                <h2 class="accordion-header" id="addStatusHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#addStatusCollapse" aria-expanded="false" aria-controls="addStatusCollapse" style="background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%); color: #fff; font-weight: bold; border-radius: 12px 12px 0 0;">
                                        <i class="bi bi-plus-circle me-2"></i> Add Status to Division
                                    </button>
                                </h2>
                                <div id="addStatusCollapse" class="accordion-collapse collapse" aria-labelledby="addStatusHeading" data-bs-parent="#addStatusAccordion">
                                    <div class="accordion-body" style="background: #f1f5f9; border-radius: 0 0 12px 12px;">
                                        <form id="addStatusForm" onsubmit="return false;">
                                            <div class="mb-3">
                                                <label for="addStatusDivision" class="form-label">Division</label>
                                                <input id="addStatusDivision" class="form-control bg-white" readonly />
                                            </div>
                                            <div class="mb-3">
                                                <label for="addStatusNameSelect" class="form-label">Status Name</label>
                                                <select id="addStatusNameSelect" class="form-select" onchange="handleStatusSelectChange()"></select>
                                                <div class="form-text">Select an existing status or type a new one below if not listed.</div>
                                            </div>
                                            <div class="mb-3" style="display: none;" id="newStatusInputContainer">
                                                <label for="addStatusNameInput" class="form-label">New Status Name</label>
                                                <input type="text" id="addStatusNameInput" class="form-control" placeholder="Enter new status name...">
                                            </div>
                                            <div class="mb-3">
                                                <label for="addStatusPosition" class="form-label">Insert Position</label>
                                                <select id="addStatusPosition" class="form-select"></select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="pizzaStatusesDropdown" class="form-label">Pizza Statuses (All)</label>
                                                <select id="pizzaStatusesDropdown" class="form-select"></select>
                                                <div class="form-text">All Pizza Statuses from pay_PizzaStatuses.json</div>
                                            </div>
                                            <div class="d-flex justify-content-end gap-2">
                                                <button type="reset" class="btn btn-secondary">Clear</button>
                                                <button type="button" class="btn btn-primary" id="addStatusConfirmBtn">Add Status</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
            <h3>üéõÔ∏è Control Center</h3>
            <div class="stats-panel" id="statsPanel" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Summary Row -->
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <div class="stat-card" style="flex: 1; text-align: center;">
                        <div class="stat-value" id="totalOperators">0</div>
                        <div class="stat-label">Total Operators</div>
                    </div>
                    <div class="stat-card" style="flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                         <div style="position: relative; width: 80px; height: 80px; margin: 0 auto;">
                             <canvas id="complianceChart"></canvas>
                         </div>
                         <div class="stat-label" style="margin-top: 5px;">Compliance</div>
                    </div>
                </div>

                <!-- Workflow Chart -->
                <div class="stat-card" style="padding: 10px;">
                    <div class="stat-label" style="margin-bottom: 5px; text-align: left;">Workflow Distribution</div>
                    <canvas id="workflowChart" style="max-height: 150px; width: 100%;"></canvas>
                </div>

                <!-- Hidden legacy tracking for compatibility -->
                <div style="display:none;">
                    <div id="validSteps">0</div>
                    <div id="invalidSteps">0</div>
                </div>
            </div>
            <div id="unsavedIndicator" class="unsaved-indicator" style="display:none;">‚ö† Unsaved changes</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color valid"></div>
                    <span>All operators have required certifications</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color invalid"></div>
                    <span>Some operators missing required certifications</span>
                </div>
            </div>
            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input type="text" id="globalSearch" class="search-input" placeholder="Search certifications, operators, or statuses..." oninput="handleGlobalSearch()">
                <button class="clear-search" onclick="clearGlobalSearch()" style="display: none;">√ó</button>
            </div>
            <div class="filter-options">
                <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All Statuses</button>
                <button class="filter-btn" data-filter="valid" onclick="setFilter('valid')">‚úì Valid Only</button>
                <button class="filter-btn" data-filter="invalid" onclick="setFilter('invalid')">‚ö† Invalid Only</button>
            </div>
            <div class="division-filter-section" style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.9rem;">üìç Filter by Division:</label>
                <select id="mainDivisionFilter" onchange="handleMainDivisionFilter()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(30, 41, 59, 0.6); color: #e2e8f0; font-size: 0.95rem;">
                    <option value="ALL">üåê All Divisions</option>
                </select>
            </div>
            <button class="btn btn-danger" onclick="showIssues()" id="issuesBtn">‚ö† Show Issues</button>
            <button id="saveBtn" class="btn btn-success" onclick="saveChanges()" style="display:none; position:fixed; bottom:40px; right:40px; z-index:3000; font-size:1.2rem; padding:18px 32px; border-radius:12px;">üíæ Save Changes</button>
            <button class="bulk-btn success" onclick="showExportModal()">üìä Export Report</button>
            <button class="bulk-btn" onclick="showCertAnalytics()">üìà Analytics</button>
            <button class="bulk-btn danger" onclick="confirmClearAll()">üóëÔ∏è Clear All Certs</button>
        </div>
        <div class="workflow-canvas" style="flex: 1;">
            <div class="workflow-steps" id="workflowSteps">
                <!-- Steps will be dynamically generated here -->
            </div>
        </div>
    </div>

@await Html.PartialAsync("_CertificationDetailsPanel")
@await Html.PartialAsync("_ExportModal")
@await Html.PartialAsync("_OperatorProfileModal")

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="/js/requirements-editor.js"></script>