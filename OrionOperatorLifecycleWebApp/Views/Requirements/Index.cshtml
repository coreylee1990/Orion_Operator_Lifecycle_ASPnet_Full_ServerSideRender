@await Html.PartialAsync("_CertDuplicateModal")
@await Html.PartialAsync("_StatusDeleteWarningModal")
@await Html.PartialAsync("_AutoAdvanceModal")
@{
    ViewData["Title"] = "Operator Lifecycle - Requirements";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="/css/requirements-editor.css" rel="stylesheet">

<div class="container" style="display: flex; flex-direction: row;">
        <div class="vertical-panel" style="width: 360px; min-width: 300px; max-width: 420px; background: #fafbfe; border-radius: 18px; margin: 30px 20px 30px 30px; padding: 28px 18px; display: flex; flex-direction: column; gap: 20px; height: fit-content; box-shadow: 0 8px 32px rgba(0,0,0,0.25);">
            
            <!-- DIVISION TITLE -->
            <h2 id="divisionTitle" style="margin: 0; color: #60a5fa; font-weight: bold; font-size: 1.35rem; text-align: center; letter-spacing: 0.5px;">All Divisions</h2>
            
            <!-- CLIENT FILTER -->
            <div class="client-filter-section" style="margin: 0;">
                <label style="display: block; margin-bottom: 8px; color: #313a46; font-size: 0.9rem; font-weight: 600;">Filter by Client</label>
                <select id="mainClientFilter" onchange="handleMainClientFilter()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; background: #ffffff; color: #313a46; font-size: 0.95rem;">
                    <option value="">Loading clients...</option>
                </select>
            </div>

            <!-- DIVISION FILTER -->
            <div class="division-filter-section" style="margin: 0;">
                <label style="display: block; margin-bottom: 8px; color: #313a46; font-size: 0.9rem; font-weight: 600;">Filter by Division</label>
                <select id="mainDivisionFilter" onchange="handleMainDivisionFilter()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; background: #ffffff; color: #313a46; font-size: 0.95rem;">
                    <option value="ALL">All Divisions</option>
                </select>
            </div>

            <!-- ANALYTICS CARDS -->
            <div class="stats-panel" id="statsPanel" style="display: flex; flex-direction: column; gap: 15px;">
                <h3 style="margin: 0; color: #313a46; font-size: 1rem; font-weight: 600; text-align: center;">Analytics</h3>
                
                <!-- Summary Row -->
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <div class="stat-card" style="flex: 1; text-align: center;">
                        <div class="stat-value" id="totalOperators">0</div>
                        <div class="stat-label">Total Operators</div>
                    </div>
                    <div class="stat-card" style="flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                         <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
                             <canvas id="complianceChart" style="width: 120px; height: 120px;"></canvas>
                         </div>
                         <div class="stat-label" style="margin-top: 5px;">Compliance</div>
                    </div>
                </div>

                <!-- Workflow Chart -->
                <div class="stat-card" style="padding: 10px;">
                    <div class="stat-label" style="margin-bottom: 5px; text-align: left; font-weight: 600;">Workflow Distribution</div>
                    <canvas id="workflowChart" style="max-height: 150px; width: 100%;"></canvas>
                </div>

                <!-- Hidden legacy tracking for compatibility -->
                <div style="display:none;">
                    <div id="validSteps">0</div>
                    <div id="invalidSteps">0</div>
                </div>
            </div>

            <!-- LEGEND -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color valid"></div>
                    <span>No operators stuck 30+ days</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color invalid"></div>
                    <span>Operators stuck 30+ days in status</span>
                </div>
            </div>

            <!-- ADD STATUS TO DIVISION -->
            <div class="accordion" id="addStatusAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="addStatusHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#addStatusCollapse" aria-expanded="false" aria-controls="addStatusCollapse">
                            Add Status to Division
                        </button>
                    </h2>
                    <div id="addStatusCollapse" class="accordion-collapse collapse" aria-labelledby="addStatusHeading" data-bs-parent="#addStatusAccordion">
                        <div class="accordion-body">
                            <form id="addStatusForm" onsubmit="return false;">
                                <div class="mb-3">
                                    <label for="addStatusDivision" class="form-label">Division</label>
                                    <input id="addStatusDivision" class="form-control bg-white" readonly />
                                </div>
                                <div class="mb-3">
                                    <label for="addStatusNameSelect" class="form-label">Status Name</label>
                                    <select id="addStatusNameSelect" class="form-select" onchange="handleStatusSelectChange()"></select>
                                    <div class="form-text">Select an existing status or type a new one below if not listed.</div>
                                </div>
                                <div class="mb-3" style="display: none;" id="newStatusInputContainer">
                                    <label for="addStatusNameInput" class="form-label">New Status Name</label>
                                    <input type="text" id="addStatusNameInput" class="form-control" placeholder="Enter new status name...">
                                </div>
                                <div class="mb-3">
                                    <label for="addStatusPosition" class="form-label">Insert Position</label>
                                    <select id="addStatusPosition" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="pizzaStatusesDropdown" class="form-label">Pizza Statuses (All)</label>
                                    <select id="pizzaStatusesDropdown" class="form-select"></select>
                                    <div class="form-text">All Pizza Statuses from pay_PizzaStatuses.json</div>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="reset" class="btn btn-secondary">Clear</button>
                                    <button type="button" class="btn btn-primary" id="addStatusConfirmBtn">Add Status</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary" onclick="showCreatePizzaStatusModal()" style="font-weight: 600;">
                    <i class="bi bi-collection" style="color: #fff;"></i> Create Pizza Status
                </button>
                <button class="btn btn-info" style="font-weight: 600;" onclick="showCreateStatusModal()">
                    <i class="bi bi-plus-lg" style="color: #fff;"></i> Create Status
                </button>
                <button class="btn btn-warning" onclick="showIssues()" style="font-weight: 600;">
                    <i class="bi bi-exclamation-triangle" style="color: #212529;"></i> Show Issues
                </button>
                <button class="btn btn-success" onclick="showExportModal()" style="font-weight: 600;">
                    <i class="bi bi-file-earmark-spreadsheet" style="color: #fff;"></i> Export Report
                </button>
                <button class="btn btn-secondary" onclick="showCertAnalytics()" style="font-weight: 600;">
                    <i class="bi bi-bar-chart-line" style="color: #fff;"></i> Analytics
                </button>
                <button class="btn btn-danger" onclick="confirmClearAll()" style="font-weight: 600;">
                    <i class="bi bi-trash" style="color: #fff;"></i> Clear All Certs
                </button>
            </div>

            <!-- UNSAVED INDICATOR -->
            <div id="unsavedIndicator" class="unsaved-indicator" style="display:none;">Unsaved changes</div>
            
            <!-- FLOATING SAVE BUTTON -->
            <button id="saveBtn" class="btn btn-success" onclick="saveChanges()" style="display:none; position:fixed; bottom:40px; right:40px; z-index:3000; font-size:1.2rem; padding:18px 32px; border-radius:12px;"><i class="bi bi-save"></i> Save Changes</button>
        </div>
        <div class="workflow-canvas" style="flex: 1;">
            <div class="workflow-steps" id="workflowSteps">
                <!-- Steps will be dynamically generated here -->
            </div>
        </div>
    </div>

<!-- Certification Details Panel Container -->
<div class="details-panel" id="detailsPanel">
    <div class="details-header">
        <h3 id="detailsTitle">Certification Details</h3>
        <div class="details-subtitle" id="detailsSubtitle"></div>
        <button class="close-panel" onclick="closeDetailsPanel()">Ã—</button>
    </div>
    <div class="details-content" id="detailsContent">
        <!-- Content loaded dynamically via JavaScript -->
    </div>
</div>

@await Html.PartialAsync("_ExportModal")
@await Html.PartialAsync("_OperatorProfileModal")

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="/js/requirements-editor.js"></script>