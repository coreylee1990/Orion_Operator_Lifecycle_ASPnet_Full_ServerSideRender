@model OrionOperatorLifecycleWebApp.Models.Operator

@{
    var validCount = ViewBag.ValidCount ?? 0;
    var missingCount = ViewBag.MissingCount ?? 0;
    var total = validCount + missingCount;
    var validPercent = total > 0 ? (validCount * 100.0 / total) : 0;
    var daysInStatus = ViewBag.DaysInStatus;
    var isOverdue = daysInStatus != null && daysInStatus >= 30;
    bool hasAllRequiredCerts = false;
    if (ViewBag.HasAllRequiredCerts != null)
    {
        hasAllRequiredCerts = (bool)ViewBag.HasAllRequiredCerts;
    }
}

<div class="operator-item @(isOverdue ? "operator-overdue" : "") @(hasAllRequiredCerts ? "operator-complete" : "")" 
     onclick="showOperatorProfile('@Model.Id')" 
     style="cursor: pointer;" 
     title="@validCount Valid, @missingCount Missing@(daysInStatus != null ? " | " + daysInStatus + " days in status" : "")">
    <div class="operator-name-row">
        <span class="operator-name">@Model.FirstName @Model.LastName</span>
        <div class="operator-badges">
            @if (total > 0)
            {
                <span class="operator-cert-count" title="@validCount valid, @missingCount missing">@validCount/@total</span>
            }
            @if (hasAllRequiredCerts && total > 0)
            {
                <span class="operator-all-complete" title="All required cert types complete">
                    <i class="bi bi-patch-check-fill"></i>
                </span>
            }
            @if (daysInStatus != null)
            {
                <span class="operator-days-in-status @(isOverdue ? "overdue" : "")" title="Days in current status">
                    @(isOverdue ? "⚠️ " : "")@(daysInStatus)d
                </span>
            }
            @* Per-operator move button: only when all required certs are present *@
            @if (hasAllRequiredCerts && total > 0)
            {
                <button type="button"
                        class="btn btn-sm btn-outline-success operator-next-status-btn"
                        title="Move this operator to the next status"
                        onclick="event.stopPropagation(); moveOperatorToNextStatusFromCard('@Model.Id');">
                    Next status
                </button>
            }
        </div>
    </div>
    <div class="progress" role="progressbar" aria-label="Certification progress" aria-valuenow="@validPercent.ToString("F0")" aria-valuemin="0" aria-valuemax="100" style="width: 100%; margin-top: 8px;">
        <div class="progress-bar" style="width: @(validPercent)%">@validPercent.ToString("F0")%</div>
    </div>
</div>
